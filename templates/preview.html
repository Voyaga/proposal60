<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Proposal Preview — Get The Job</title>
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>

  <div class="wrap">

    <h1>Proposal Preview</h1>

    {% set blocked = blocked | default(false) %}
    {% set remaining = remaining | default(0) %}
    {% set block_reason = block_reason | default("free") %}

    {% if blocked %}
      <div class="notice">
        {% if block_reason == "rate" %}
          <strong>Too many requests.</strong><br>
          Please wait a minute and try again.
        {% else %}
          <strong>You’ve reached the free limit.</strong><br>
          Upgrade to continue.
        {% endif %}

        {% if not is_pro %}
          <div style="margin-top:16px;">
            <a href="/upgrade" class="btn">Upgrade to Pro</a>
          </div>
        {% endif %}
      </div>

    {% else %}
      <div class="notice">
        <strong>Free proposals remaining:</strong> {{ remaining }}
      </div>

      <p class="helper">
        Review and edit before sending.
      </p>

      <!-- Actions -->
      <div class="actions">
        <button class="btn secondary" id="editBtn" onclick="enableEdit()" disabled>
          Edit proposal
        </button>

        <button class="btn" onclick="copyText()" disabled id="copyBtn">
          Copy
        </button>

        <form method="POST" action="/pdf" onsubmit="syncHidden();">
          <textarea
            id="proposalHidden"
            name="proposal_text"
            style="display:none;"
          ></textarea>
          <button class="btn secondary" type="submit" disabled id="pdfBtn">
            Download PDF
          </button>
        </form>
      </div>

      <!-- Editor -->
      <textarea
        id="proposalEditor"
        class="proposal-editor locked"
        rows="20"
        readonly
      >{{ proposal_text }}</textarea>

      <!-- Empty state -->
      <div id="emptyNotice" class="notice" style="display:none;">
        <strong>No proposal loaded.</strong><br>
        Create a proposal to preview, edit, or download.
      </div>

      <a id="goEditorBtn" href="/app" class="btn" style="display:none;">
        Go to editor
      </a>

    {% endif %}

    <footer class="site-footer">
      © Get The Job
    </footer>

  </div>

  <!-- Back button -->
  <a href="/app" class="btn secondary preview-back-btn">
    ← Back to editor
  </a>

<script>
const ACTIVE_KEY = "gtj_active_proposal";
const HISTORY_KEY = "gtj_proposal_history";
const MAX_HISTORY = 5;

const editor = document.getElementById("proposalEditor");
const emptyNotice = document.getElementById("emptyNotice");
const goEditorBtn = document.getElementById("goEditorBtn");

const editBtn = document.getElementById("editBtn");
const copyBtn = document.getElementById("copyBtn");
const pdfBtn = document.getElementById("pdfBtn");

function enableActions() {
  editBtn.disabled = false;
  copyBtn.disabled = false;
  pdfBtn.disabled = false;
}

document.addEventListener("DOMContentLoaded", () => {
  if (editor && editor.value.trim()) {
    enableActions();
    saveToHistory(editor.value.trim());
    return;
  }

  const stored = localStorage.getItem(ACTIVE_KEY);
  if (stored) {
    try {
      const data = JSON.parse(stored);
      if (data.text) {
        editor.value = data.text;
        enableActions();
        saveToHistory(data.text);
      }
      localStorage.removeItem(ACTIVE_KEY);
      return;
    } catch {}
  }

  emptyNotice.style.display = "block";
  goEditorBtn.style.display = "inline-block";
});

function saveToHistory(text) {
  let history = [];
  try {
    history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  } catch {}

  history = history.filter(h => h.text !== text);

  history.unshift({
    text: text,
    client: "{{ request.form.get('client_name', 'Client') }}",
    service: "{{ request.form.get('service_type', 'Service') }}",
    ts: Date.now()
  });

  if (history.length > MAX_HISTORY) {
    history = history.slice(0, MAX_HISTORY);
  }

  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function enableEdit(){
  editor.removeAttribute("readonly");
  editor.classList.remove("locked");
  editor.focus();

  editBtn.textContent = "Editing enabled";
  editBtn.disabled = true;
}

function syncHidden(){
  document.getElementById("proposalHidden").value = editor.value;
}

function copyText(){
  navigator.clipboard.writeText(editor.value);
}
</script>

</body>
</html>
